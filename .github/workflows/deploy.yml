name: Deploy LottoDrop
# Initial deployment: 2026-01-23

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'frontend-admin/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'What to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
          - admin

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/lottodrop-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/lottodrop-frontend
  ADMIN_IMAGE: ghcr.io/${{ github.repository_owner }}/lottodrop-admin

jobs:
  # ============================================
  # Build Backend Image
  # ============================================
  build-backend:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.deploy_target == 'all' ||
      github.event.inputs.deploy_target == 'backend'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

  # ============================================
  # Build Frontend Image
  # ============================================
  build-frontend:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.deploy_target == 'all' ||
      github.event.inputs.deploy_target == 'frontend'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

  # ============================================
  # Build Admin Panel Image
  # ============================================
  build-admin:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.deploy_target == 'all' ||
      github.event.inputs.deploy_target == 'admin'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push admin
        uses: docker/build-push-action@v5
        with:
          context: ./frontend-admin
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.ADMIN_IMAGE }}:latest
            ${{ env.ADMIN_IMAGE }}:${{ github.sha }}
          cache-from: type=gha,scope=admin
          cache-to: type=gha,mode=max,scope=admin

  # ============================================
  # Deploy to Production Server
  # ============================================
  deploy:
    needs: [build-backend, build-frontend, build-admin]
    if: always() && !cancelled() && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://lottodrop.net

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}
          ADMIN_IMAGE: ${{ env.ADMIN_IMAGE }}
          DEPLOY_TARGET: ${{ github.event.inputs.deploy_target || 'all' }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          envs: BACKEND_IMAGE,FRONTEND_IMAGE,ADMIN_IMAGE,DEPLOY_TARGET
          script: |
            set -e

            echo "========================================"
            echo "üöÄ LottoDrop Deployment Starting..."
            echo "========================================"
            echo "Target: $DEPLOY_TARGET"
            echo "Commit: ${{ github.sha }}"

            cd /opt/lottodrop

            # Login to GitHub Container Registry (optional for public images)
            if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin || echo "‚ö†Ô∏è GHCR login failed, continuing with public access"
            else
              echo "‚ÑπÔ∏è No GHCR_TOKEN configured, using public access"
            fi

            # Pull new images based on target
            echo "üì• Pulling new images..."
            if [ "$DEPLOY_TARGET" = "all" ] || [ "$DEPLOY_TARGET" = "backend" ]; then
              docker pull $BACKEND_IMAGE:latest
            fi
            if [ "$DEPLOY_TARGET" = "all" ] || [ "$DEPLOY_TARGET" = "frontend" ]; then
              docker pull $FRONTEND_IMAGE:latest
            fi
            if [ "$DEPLOY_TARGET" = "all" ] || [ "$DEPLOY_TARGET" = "admin" ]; then
              docker pull $ADMIN_IMAGE:latest
            fi

            # Restart services with zero downtime
            echo "üîÑ Restarting services..."
            if [ "$DEPLOY_TARGET" = "all" ]; then
              docker compose -f docker-compose.prod.yml up -d --no-deps backend frontend admin
            elif [ "$DEPLOY_TARGET" = "backend" ]; then
              docker compose -f docker-compose.prod.yml up -d --no-deps backend
            elif [ "$DEPLOY_TARGET" = "frontend" ]; then
              docker compose -f docker-compose.prod.yml up -d --no-deps frontend
            elif [ "$DEPLOY_TARGET" = "admin" ]; then
              docker compose -f docker-compose.prod.yml up -d --no-deps admin
            fi

            # Wait for services to start
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 20

            # Health checks
            echo "üè• Running health checks..."

            if [ "$DEPLOY_TARGET" = "all" ] || [ "$DEPLOY_TARGET" = "backend" ]; then
              curl -f http://127.0.0.1:3001/health || { echo "‚ùå Backend health check failed"; exit 1; }
              echo "‚úì Backend healthy"
            fi

            if [ "$DEPLOY_TARGET" = "all" ] || [ "$DEPLOY_TARGET" = "frontend" ]; then
              curl -f http://127.0.0.1:8080 -o /dev/null -s || { echo "‚ùå Frontend health check failed"; exit 1; }
              echo "‚úì Frontend healthy"
            fi

            if [ "$DEPLOY_TARGET" = "all" ] || [ "$DEPLOY_TARGET" = "admin" ]; then
              curl -f http://127.0.0.1:8081 -o /dev/null -s || { echo "‚ùå Admin health check failed"; exit 1; }
              echo "‚úì Admin healthy"
            fi

            # Cleanup old images (keep last 3 versions)
            echo "üßπ Cleaning up old images..."
            docker image prune -af --filter "until=72h"

            echo "========================================"
            echo "‚úÖ Deployment completed successfully!"
            echo "üìä Version: ${{ github.sha }}"
            echo "========================================"

      - name: Post deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
